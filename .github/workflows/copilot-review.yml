name: ðŸ¤– Copilot Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  copilot-review-setup:
    name: ðŸ§  Setup Copilot Review
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Quick PR Template Check
        run: |
          if echo "${{ github.event.pull_request.body }}" | grep -q "## ðŸ“‹ Description"; then
            echo "âœ… PR follows template structure"
          else
            echo "âš ï¸ PR template may be incomplete"
          fi

      - name: ï¿½ Add Copilot Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ðŸ¤– Copilot Automated Review Setup

            Hi! I'm reviewing this PR based on the AnimeBOX project standards.

            ### ðŸ“‹ Review Checklist
            - TypeScript strict typing and compilation
            - React Native mobile best practices  
            - Drizzle ORM type-safe database operations
            - Testing coverage for new functionality
            - Performance and accessibility considerations

            ### ðŸŽ¯ Focus Areas
            I'll provide detailed feedback on code quality, architecture, and best practices.

            ---
            *Following [Copilot Instructions](.github/copilot-instructions.md) for consistent reviews.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

  enforce-quality-checks:
    name: ðŸ›¡ï¸ Quality Gate Enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: ðŸ“¦ Install dependencies
        run: yarn install --immutable

      - name: ðŸ” TypeScript Check
        run: |
          echo "ðŸ” Running TypeScript compilation check..."
          yarn type-check
          echo "âœ… TypeScript check passed"

      - name: ðŸŽ¨ ESLint Check
        run: |
          echo "ðŸŽ¨ Running ESLint..."
          yarn lint
          echo "âœ… ESLint check passed"

      - name: ðŸ§ª Test Suite
        run: |
          echo "ðŸ§ª Running test suite..."
          yarn test --coverage --watchAll=false
          echo "âœ… All tests passed"

      - name: ðŸ“ Markdown Lint Check
        run: |
          echo "ðŸ“ Checking markdown documentation..."
          if ls docs/**/*.md .github/**/*.md 1> /dev/null 2>&1; then
            yarn markdownlint docs/**/*.md .github/**/*.md
            echo "âœ… Markdown linting passed"
          else
            echo "â„¹ï¸ No markdown files to check"
          fi

      - name: ðŸ“Š Quality Gate Summary
        run: |
          echo "## âœ… Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All automated quality checks have passed:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” TypeScript compilation: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ ESLint (code style): âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Test suite: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Markdown linting: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR meets the technical quality standards for merge consideration." >> $GITHUB_STEP_SUMMARY
