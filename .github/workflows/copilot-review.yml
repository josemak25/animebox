name: ğŸ¤– Copilot Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  copilot-review-setup:
    name: ğŸ§  Setup Copilot Review
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check PR Template Compliance
        run: |
          # Check if PR body follows our template structure
          if ! echo "${{ github.event.pull_request.body }}" | grep -q "## ğŸ“‹ Description"; then
            echo "âŒ PR does not follow the required template structure"
            echo "Please use the PR template with proper sections: Description, Type of Change, Testing, etc."
            exit 1
          else
            echo "âœ… PR follows template structure"
          fi

      - name: ğŸ“Š Analyze PR Changes
        run: |
          echo "ğŸ” Analyzing changes in PR #${{ github.event.number }}"
          
          # Get list of changed files
          gh api repos/${{ github.repository }}/pulls/${{ github.event.number }}/files \
            --jq '.[].filename' > changed_files.txt
          
          # Categorize changes
          if grep -q "^app/" changed_files.txt; then
            echo "ğŸ“± App routing changes detected"
          fi
          
          if grep -q "^components/" changed_files.txt; then
            echo "ğŸ§© UI component changes detected"
          fi
          
          if grep -q "^db/" changed_files.txt; then
            echo "ğŸ—„ï¸ Database changes detected - requires careful review"
          fi
          
          if grep -q "^helpers/" changed_files.txt; then
            echo "ğŸ› ï¸ Utility function changes detected"
          fi
          
          if grep -q "\\.test\\." changed_files.txt || grep -q "__tests__" changed_files.txt; then
            echo "ğŸ§ª Test changes detected"
          fi
          
          if grep -q "\\.md$" changed_files.txt; then
            echo "ğŸ“š Documentation changes detected"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Add Review Labels
        run: |
          labels=()
          
          # Add labels based on changed files
          if grep -q "^app/" changed_files.txt; then
            labels+=("ğŸ—ï¸ architecture")
          fi
          
          if grep -q "^components/" changed_files.txt; then
            labels+=("ğŸ¨ ui-components")
          fi
          
          if grep -q "^db/" changed_files.txt; then
            labels+=("ğŸ—„ï¸ database")
          fi
          
          if grep -q "\\.test\\." changed_files.txt || grep -q "__tests__" changed_files.txt; then
            labels+=("ğŸ§ª tests")
          fi
          
          if grep -q "\\.md$" changed_files.txt; then
            labels+=("ğŸ“š documentation")
          fi
          
          # Add labels to PR
          for label in "${labels[@]}"; do
            gh api repos/${{ github.repository }}/issues/${{ github.event.number }}/labels \
              --method POST \
              --field name="$label" || echo "Label '$label' may already exist"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ Add Copilot Review Comment
        run: |
          cat << 'EOF' > review_comment.md
          ## ğŸ¤– Copilot Automated Review

          Hi! I'm reviewing this PR based on the AnimeBOX project standards. Here's what I'm checking:

          ### ğŸ“‹ Review Checklist
          - [ ] **TypeScript**: Strict typing, no `any` types
          - [ ] **React Native**: Following mobile best practices
          - [ ] **Drizzle ORM**: Type-safe database operations
          - [ ] **Testing**: New tests for new functionality
          - [ ] **Performance**: No unnecessary re-renders
          - [ ] **Documentation**: Adequate code comments
          - [ ] **Architecture**: Follows project structure

          ### ğŸ¯ Focus Areas for This PR
          Based on the files changed, I'll pay special attention to:
          EOF
          
          # Add specific focus areas based on changes
          if grep -q "^db/" changed_files.txt; then
            echo "- ğŸ—„ï¸ **Database Changes**: Schema migrations, type safety, query optimization" >> review_comment.md
          fi
          
          if grep -q "^app/" changed_files.txt; then
            echo "- ğŸ“± **Routing Changes**: Expo Router conventions, navigation patterns" >> review_comment.md
          fi
          
          if grep -q "^components/" changed_files.txt; then
            echo "- ğŸ§© **UI Components**: React Native styling, responsive design, accessibility" >> review_comment.md
          fi
          
          cat << 'EOF' >> review_comment.md

          ### ğŸ“– Review Guidelines
          Following our [Copilot Instructions](.github/copilot-instructions.md) for consistent reviews.

          I'll provide detailed feedback on code quality, performance, and best practices. Feel free to ask questions about any suggestions!

          ---
          *This automated review helps maintain code quality. Human reviewers should also review this PR.*
          EOF

          gh pr comment ${{ github.event.number }} --body-file review_comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  enforce-quality-checks:
    name: ğŸ›¡ï¸ Quality Gate Enforcement
    runs-on: ubuntu-latest
    needs: copilot-review-setup
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --immutable

      - name: ğŸ” TypeScript Check
        run: |
          echo "ğŸ” Running TypeScript compilation check..."
          yarn type-check
          echo "âœ… TypeScript check passed"

      - name: ğŸ¨ ESLint Check
        run: |
          echo "ğŸ¨ Running ESLint..."
          yarn lint
          echo "âœ… ESLint check passed"

      - name: ğŸ§ª Test Suite
        run: |
          echo "ğŸ§ª Running test suite..."
          yarn test --coverage --watchAll=false
          echo "âœ… All tests passed"

      - name: ğŸ“ Markdown Lint Check
        run: |
          echo "ğŸ“ Checking markdown documentation..."
          if ls docs/**/*.md .github/**/*.md 1> /dev/null 2>&1; then
            yarn markdownlint docs/**/*.md .github/**/*.md
            echo "âœ… Markdown linting passed"
          else
            echo "â„¹ï¸ No markdown files to check"
          fi

      - name: ğŸ“Š Quality Gate Summary
        run: |
          cat << 'EOF'
          ## âœ… Quality Gate Results
          
          All automated quality checks have passed:
          - ğŸ” TypeScript compilation: âœ… Passed
          - ğŸ¨ ESLint (code style): âœ… Passed  
          - ğŸ§ª Test suite: âœ… Passed
          - ğŸ“ Markdown linting: âœ… Passed
          
          This PR meets the technical quality standards for merge consideration.
          EOF
